<!DOCTYPE html>
<html>
<head>
	<title><%= $title %></title>
	<meta charset="utf-8">
% if ($self->stash('refresh_interval')) {
	<meta http-equiv="refresh" content="<%= $self->stash('refresh_interval') %>"/>
% }

	%= stylesheet '/infoscreen.css'
	%= javascript '/jquery-2.1.1.min.js'
	%= javascript '/collapse.js'
</head>
<body>

% if (my $error = stash 'error') {
<div class="error">Received an error from the backend service:</div>
<div>
<pre>
%= $error
</pre>
</div>
% }

<div class="displayclean">
<ul>
% for my $departure (@{$raw}) {
%   my $linetype = q{};
%   if ($departure->can('type')) {
%     given ($departure->type) {
%       when ($_ =~ m{enbahn$}) { $linetype = 'tram' }
%       when ('S-Bahn')       { $linetype = 'sbahn' }
%       when ([qw[NE Niederflurbus SB Bus]]) { $linetype = 'bus' }
%       when ('U-Bahn')       { $linetype = 'ubahn' }
%     }
%   }
    <li>
    <span class="line <%= $linetype %>">
    %= $departure->line
    </span> <!-- line -->
    <span class="moreinfo">
    <div class="mheader">
    <span class="train-line"><%= $departure->line %></span>
    :
    <span class="train-route">
%   if ($departure->can('lineref') and $departure->lineref) {
%=    $departure->lineref->route
%   }
%   elsif ($departure->can('route_pre') and $departure->can('route_post')) {
%     if ($departure->route_pre) {
%=      ($departure->route_pre)[0]->{stop}
%     }
%     if ($departure->route_post) {
%       ($departure->route_post)[-1]->{stop}
%     }
%   }
    </span> <!-- train-route -->
    </div> <!-- mheader -->
%   if ($departure->can('route_pre')) {
      Fahrplan:
      <ul>
%     for my $stop ($departure->route_pre) {
        <li><%= $stop->{dep_time} %> <%= $stop->{stop} %></li>
%     }
      </ul>
%   }
%   if ($departure->can('route_post')) {
      <ul>
%     for my $stop ($departure->route_post) {
        <li><%= $stop->{arr_time} %> <%= $stop->{stop} %></li>
%     }
      </ul>
%   }
    </span> <!-- moreinfo -->
    <span class="route">
%   if ($departure->can('route_interesting') and $departure->route_interesting) {
%=    join(' - ', map { $_->{stop_suf} } ($departure->route_interesting));
%   }
%   elsif ($departure->can('lineref') and $departure->lineref) {
%=    $departure->lineref->route
%   }
%   elsif ($departure->can('route_timetable')) {
%     my @first_deps = ($departure->route_timetable)[0..2];
%     delete $first_deps[2] unless defined $first_deps[2];
%     delete $first_deps[1] unless defined $first_deps[1];
%     delete $first_deps[0] unless defined $first_deps[0];
%=    join(' - ', map { $_->[1] } @first_deps );
%   }
    </span> <!-- route -->
    <span class="dest">
%=  $departure->destination
    </span> <!-- dest -->
    <span class="countdown">
%   if ($departure->can('delay') and $departure->delay) {
      <span class="delay"> (+<%= $departure->delay %>) </span>
%   }
%   if ($departure->can('is_cancelled') and $departure->is_cancelled) {
      <span class="delay"> FÃ„LLT AUS </span>
%   }
%   else {
%     if ($departure->countdown > 0) {
        <%= $departure->countdown %> min
%     }
%     else {
        sofort
%     }
%   }
    </span> <!-- countdown -->
    <span class="time">
%=  $departure->time
    </span>
    </li>
% }
</ul>
</div>

</body>
</html>
